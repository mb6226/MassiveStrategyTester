# MT5 Batch Backtest Setup

This document will explain how to configure MetaTrader 5 (MT5) for automated, large-scale batch backtesting using `.ini` configuration files and the `terminal64.exe` command line interface.

---

## 1. Overview

Batch backtesting in MT5 is achieved by preparing multiple `.ini` files (one per strategy or configuration) and running the MT5 terminal in command line mode. This allows for fully automated, large-scale testing of many strategies without manual intervention.

---

## 2. Prerequisites
- MetaTrader 5 installed on your system
- Access to `terminal64.exe` (the MT5 executable)
- Compiled Expert Advisor (`.ex5` file) for your strategy
- Python scripts from this project:
  - `PythonCore/ini_generator.py`
  - `PythonCore/mt5_runner.py`
  - `PythonCore/result_parser.py`
  - `PythonCore/pareto_filter.py`

---

## 3. Creating the Base `.ini` File

1. Open MT5 and configure a single backtest manually in the Strategy Tester.
2. Save the configuration as an `.ini` file (usually via the "Save" button in the Strategy Tester window).
3. This file will serve as a template for batch generation.

Example template content:

```ini
[Tester]
Expert=MyStrategy.ex5
Symbol=EURUSD1
Model=0
StartDate=2025.06.01
EndDate=2025.06.20
Deposit=10000
Report=Backtests/results/strategy_{STRATEGY_ID}
ReportMode=4
ShutdownTerminal=false
ReplaceReport=true
UseLocal=true
UseCloud=false
CustomMode=true
Period=1
Optimization=false
Inputs=Risk=0.01;Magic={STRATEGY_ID};
```

---

## 4. Automating `.ini` File Generation

Use the provided Python script `PythonCore/ini_generator.py` to generate multiple `.ini` files, each with different strategy parameters or symbols.

Minimal version of `ini_generator.py`:

```python
# PythonCore/ini_generator.py
import os
import argparse

TEMPLATE_PATH = "Backtests/configs/template.ini"
OUTPUT_DIR = "Backtests/configs/"
STRATEGY_COUNT = 10

def generate_ini(template_path, output_dir, count):
    with open(template_path, 'r') as file:
        template = file.read()

    for i in range(1, count + 1):
        strategy_id = f"{i:03}"
        ini_content = template.replace("{STRATEGY_ID}", strategy_id)
        output_file = os.path.join(output_dir, f"strategy_{strategy_id}.ini")
        with open(output_file, 'w') as f:
            f.write(ini_content)
        print(f"✅ Created: {output_file}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--template', type=str, default=TEMPLATE_PATH)
    parser.add_argument('--output', type=str, default=OUTPUT_DIR)
    parser.add_argument('--count', type=int, default=STRATEGY_COUNT)
    args = parser.parse_args()

    os.makedirs(args.output, exist_ok=True)
    generate_ini(args.template, args.output, args.count)
```

Run with:
```bash
python PythonCore/ini_generator.py --count 20
```

---

## 5. Running Batch Backtests

Use the provided Python script `PythonCore/mt5_runner.py` to run MT5 in batch mode:

```bash
python PythonCore/mt5_runner.py --terminal_path "C:\Program Files\Assets Global MetaTrader 5 Terminal\terminal64.exe" --config_dir "Backtests/configs"
```

This script will loop over all `.ini` files in the specified directory and execute them one by one using MT5.

Make sure that offline data for symbol `EURUSD1` is available in the correct location, such as:
```
C:\Users\Administrator\AppData\Roaming\MetaQuotes\Terminal\9BED29E7C9FF09009AD0965CA30D5330\bases\Custom\history\EURUSD1\cache\M1.hc
```
And the matching `.thc` tick files are present in:
```
C:\Users\Administrator\AppData\Roaming\MetaQuotes\Terminal\9BED29E7C9FF09009AD0965CA30D5330\bases\Custom\ticks\EURUSD1
```

---

## 6. Parsing and Analyzing Results Automatically

After all backtests are complete, run the script `PythonCore/result_parser.py` to extract and aggregate the results:

```bash
python PythonCore/result_parser.py --input_dir Backtests/results --output_file Backtests/summary.csv
```

This script scans all HTML files generated by MT5, extracts key metrics (e.g., total trades, profit, drawdown), and saves them in a CSV summary for downstream analysis.

Next, to filter the results and keep only the strategies that pass performance criteria (e.g., profit > 0, drawdown < 30%), run:

```bash
python PythonCore/pareto_filter.py --input_file Backtests/summary.csv --output_file Backtests/filtered_strategies.csv
```

This will select only the strategies that pass performance criteria (e.g., profit > 0, drawdown < 30%).

> ✅ If you run the full pipeline using:
> ```bash
> python PythonCore/pipeline.py --num_strategies 50 --symbol EURUSD --data Data/prepared_m1.csv
> ```
> The result parsing and filtering will automatically run at the end.

---

## 7. Filtering Pareto-optimal Strategies (Optional)

If you want to keep only the most promising strategies based on multi-objective criteria (like high profit & low drawdown), use the Pareto filter script:

```bash
python PythonCore/pareto_filter.py --input_file Backtests/summary.csv --output_file Backtests/filtered_strategies.csv
```

This script applies Pareto filtering on the CSV and extracts non-dominated strategies.

---

## 8. Troubleshooting
- Ensure all file paths in `.ini` files are correct and use double backslashes (`\\`) on Windows.
- Make sure MT5 is closed before running batch tests to avoid conflicts.
- Check the output folder for result files after each run.
- Ensure the offline symbol name (e.g. `EURUSD1`) matches the `.ini` file symbol exactly.

---

## 9. References
- [MetaTrader 5 Command Line Documentation](https://www.metatrader5.com/en/terminal/help/start_advanced/command_line)
- Project files:
  - `PythonCore/ini_generator.py`
  - `PythonCore/mt5_runner.py`
  - `PythonCore/result_parser.py`
  - `PythonCore/pareto_filter.py`

---

## 10. Example Directory Structure

```
MassiveStrategyTester/
├── Backtests/
│   ├── configs/
│   │   ├── template.ini
│   │   ├── strategy_001.ini
│   │   └── ...
│   └── results/
│       ├── strategy_001.html
│       ├── ...
│       └── summary.csv
├── PythonCore/
│   ├── ini_generator.py
│   ├── mt5_runner.py
│   ├── result_parser.py
│   └── pareto_filter.py
```

---

## 11. Sample Output Commands

```bash
python PythonCore/mt5_runner.py --terminal_path "C:\Program Files\Assets Global MetaTrader 5 Terminal\terminal64.exe" --config_dir "Backtests/configs"
```

And then:

```bash
python PythonCore/result_parser.py --input_dir Backtests/results --output_file Backtests/summary.csv
```

Then (optional):

```bash
python PythonCore/pareto_filter.py --input_file Backtests/summary.csv --output_file Backtests/filtered_strategies.csv
```

> Each strategy will run inside MT5 with the specified `.ini` file. Results will be saved to the configured path and parsed into a CSV summary automatically.
